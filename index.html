<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Saver 88/8 Calculator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2pdf.js for real PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700;800&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Custom Scrollbar for table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #002d63;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #002d63;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- INLINE ICONS (To prevent White Screen Crash) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const Calculator = (p) => <IconBase {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
        const FileText = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const PieChart = (p) => <IconBase {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Delete = (p) => <IconBase {...p}><path d="M20 5H9l-7 7 7 7h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/><line x1="18" x2="12" y1="9" y2="15"/><line x1="12" x2="18" y1="9" y2="15"/></IconBase>;
        const Home = (p) => <IconBase {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const RefreshCcw = (p) => <IconBase {...p}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></IconBase>;
        const InfinityIcon = (p) => <IconBase {...p}><path d="M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4Zm0 0c2 2.67 4 4 6 4a4 4 0 1 0 0-8c-2 0-4 1.33-6 4Z"/></IconBase>;

        // --- PREMIUM RATES DATA ---
        const PREMIUM_RATES_FULL = {
            male: {
        20: 689, 21: 695, 22: 700, 23: 705, 24: 711,
        25: 717, 26: 723, 27: 729, 28: 735, 29: 742,
        30: 749, 31: 756, 32: 763, 33: 770, 34: 778,
        35: 786, 36: 794, 37: 802, 38: 810, 39: 819,
        40: 828, 41: 837, 42: 846, 43: 856, 44: 866,
        45: 876, 46: 886, 47: 896, 48: 907, 49: 918,
        50: 929, 51: 941, 52: 952, 53: 964, 54: 976,
        55: 989, 56: 1001, 57: 1007, 58: 1014, 59: 1021,
        60: 1027
    },
    female: {
        20: 658, 21: 663, 22: 668, 23: 673, 24: 678,
        25: 684, 26: 689, 27: 695, 28: 701, 29: 707,
        30: 714, 31: 720, 32: 727, 33: 734, 34: 741,
        35: 749, 36: 756, 37: 764, 38: 772, 39: 781,
        40: 789, 41: 798, 42: 807, 43: 817, 44: 826,
        45: 833, 46: 846, 47: 857, 48: 867, 49: 878,
        50: 890, 51: 901, 52: 913, 53: 925, 54: 938,
        55: 951, 56: 964, 57: 977, 58: 991, 59: 1005,
        60: 1019
    }
};

        const getRateForAge = (age, gender) => {
    const rates = PREMIUM_RATES_FULL[gender === 'm' ? 'male' : 'female'];
    
    // Clamp อายุระหว่าง 20-60 ปี
    const clampedAge = Math.max(20, Math.min(age, 60));
    
    // คืนค่าเป็นอัตราต่อ 1,000 บาททุนประกัน
    return rates[clampedAge] || rates[20];
};

    // --- IRR CALCULATION ---
const calculateIRR = (flows) => {
    let guess = 0.02;
    for (let i = 0; i < 100; i++) {
        let npv = 0; let dNpv = 0;
        for (let t = 0; t < flows.length; t++) {
            const d = Math.pow(1 + guess, t);
            npv += flows[t] / d;
            dNpv -= (t * flows[t]) / (d * (1 + guess));
        }
        if (Math.abs(dNpv) < 1e-12) break;
        let next = guess - npv / dNpv;
        if (Math.abs(next - guess) < 1e-7) return next;
        guess = next;
    }
    return null;
};

const App = () => {
    const [authorized, setAuthorized] = useState(false);
    const [step, setStep] = useState('calc'); 
    const [inputs, setInputs] = useState({ age: 35, gender: 'm', mode: 'sa', amount: 100000 });
    const [result, setResult] = useState(null);
    const [loading, setLoading] = useState(false);

    const handleCalculate = () => {
    // ============================================
    // 1. VALIDATION - ตรวจสอบข้อมูลเบื้องต้น (ใหม่)
    // ============================================
    
    // ตรวจสอบอายุ (20-60 ปีตาม PDF)
    if (!inputs.age || inputs.age < 20 || inputs.age > 60) {
        alert('⚠️ อายุผู้เอาประกันต้องอยู่ระหว่าง 20-60 ปี');
        return;
    }
    
    // ตรวจสอบเงินทุน/เบี้ยประกัน
    if (!inputs.amount || inputs.amount <= 0) {
        alert('⚠️ กรุณากรอกจำนวนเงินที่ถูกต้อง');
        return;
    }
    
    // ตรวจสอบเพศ
    if (!inputs.gender || (inputs.gender !== 'm' && inputs.gender !== 'f')) {
        alert('⚠️ กรุณาเลือกเพศ');
        return;
    }
    
    // ============================================
    // 2. เริ่มต้นการคำนวณ
    // ============================================
    setLoading(true);
    
    setTimeout(() => {
        try {
            // ดึงอัตราเบี้ยจากตาราง (ต่อ 1,000 บาททุนประกัน)
            const ratePer1K = getRateForAge(inputs.age, inputs.gender);
            
            // ตรวจสอบว่าดึงค่าได้
            if (!ratePer1K || ratePer1K <= 0) {
                alert('ไม่พบอัตราเบี้ยสำหรับอายุนี้ กรุณาตรวจสอบข้อมูล');
                setLoading(false);
                return;
            }
            
            let sa = 0; // Sum Assured (ทุนประกัน)
            let annPrem = 0; // Annual Premium (เบี้ยประกันต่อปี)
            
            // คำนวณตามโหมด (ใหม่: คำนวณจากอัตราต่อ 1,000 บาท)
            if (inputs.mode === 'sa') {
                // โหมดระบุทุนประกัน
                sa = inputs.amount;
                annPrem = (sa / 1000) * ratePer1K; // เปลี่ยนจาก /1,000,000 เป็น /1,000
                annPrem = Math.round(annPrem); // ปัดเศษ
            } else {
                // โหมดระบุเบี้ยประกัน
                annPrem = inputs.amount;
                // คำนวณทุนประกันจากเบี้ยประกัน
                sa = Math.floor((annPrem / ratePer1K) * 1000 / 1000) * 1000; // ปรับสูตร
                // คำนวณเบี้ยประกันใหม่จากทุนที่ปัดเศษแล้ว
                annPrem = Math.round((sa / 1000) * ratePer1K);
            }
            
            // ตรวจสอบขั้นต่ำทุนประกันตาม PDF หน้า 14
            if (sa < 50000) {
                alert('⚠️ ทุนประกันภัยขั้นต่ำคือ 50,000 บาท (ตามเงื่อนไขกรมธรรม์)');
                setLoading(false);
                return;
            }
            
            if (sa > 200000) {
                alert('⚠️ ทุนประกันภัยสูงสุดคือ 200,000 บาท (ตามเงื่อนไขกรมธรรม์)');
                setLoading(false);
                return;
            }
            
            // ตรวจสอบขั้นต่ำเบี้ยประกัน
            if (annPrem < 1000) {
                alert('⚠️ เบี้ยประกันขั้นต่ำคือ 1,000 บาทต่อปี');
                setLoading(false);
                return;
            }

            // ============================================
            // 3. การคำนวณผลประโยชน์ (เหมือนเดิม)
            // ============================================
            const duration = 88 - inputs.age;
            const flows = [];
            const irrStream = [-annPrem];
            let cumPrem = 0;
            let cumCash = 0;

            for (let t = 1; t <= duration; t++) {
                const year = t;
                const curAge = inputs.age + t;
                const p = t <= 8 ? annPrem : 0;
                const c = curAge < 88 ? (sa * 0.088) : 0;
                const m = curAge === 88 ? (sa * 8.88) : 0;
                
                if (t <= 8) cumPrem += annPrem;
                cumCash += c;

                // Step-up Death Benefit Logic (ตาม PDF หน้า 15)
                let dbPercent = 0;
                if(year === 1) dbPercent = 1.08;
                else if(year === 2) dbPercent = 2.08;
                else if(year === 3) dbPercent = 3.08;
                else if(year === 4) dbPercent = 4.08;
                else if(year === 5) dbPercent = 5.08;
                else if(year === 6) dbPercent = 6.08;
                else if(year === 7) dbPercent = 7.08;
                else dbPercent = 8.08; // ปีที่ 8 เป็นต้นไป
                
                const deathBenefit = sa * dbPercent;

                flows.push({ 
                    year, 
                    age: curAge, 
                    premium: p, 
                    cashback: c, 
                    maturity: m, 
                    deathBenefit, 
                    totalYearly: c + m 
                });
                
                let net = (c + m);
                if (t <= 8) net -= annPrem;
                irrStream[t] = net;
            }

            setResult({
                sa, 
                annPrem, 
                cumPrem, 
                cumCash,
                maturity: sa * 8.88,
                totalBenefit: cumCash + (sa * 8.88),
                netProfit: (cumCash + (sa * 8.88)) - cumPrem,
                irr: calculateIRR(irrStream) * 100,
                flows,
                isCampaign: annPrem >= 400000,
                ratePer1K: ratePer1K // เพิ่มข้อมูลสำหรับแสดงผล
            });
            
            setStep('result');
            setLoading(false);
            
        } catch (error) {
            console.error('Error in calculation:', error);
            alert('เกิดข้อผิดพลาดในการคำนวณ');
            setLoading(false);
        }
    }, 500);
};
    const resetAll = () => {
        setStep('calc');
        setResult(null);
    };

    if (!authorized) return <Numpad onAuth={() => setAuthorized(true)} />;

    return (
        <div className="min-h-screen bg-slate-50 text-slate-900">
            {step === 'calc' && <InputView inputs={inputs} setInputs={setInputs} onCalc={handleCalculate} loading={loading} />}
            {step === 'result' && <Dashboard result={result} inputs={inputs} onBack={resetAll} onReport={() => setStep('report')} />}
            {step === 'report' && <ReportView result={result} inputs={inputs} onBack={() => setStep('result')} />}
        </div>
    );
};

        // --- NUMPAD VIEW ---
        const Numpad = ({ onAuth }) => {
            const [pin, setPin] = useState('');
            const handlePress = (n) => {
                if (pin.length < 4) {
                    const next = pin + n;
                    setPin(next);
                    if (next === '2026') onAuth();
                    else if (next.length === 4) setTimeout(() => setPin(''), 500);
                }
            };
            return (
                <div className="fixed inset-0 bg-[#002d63] flex flex-col items-center justify-center p-6">
                    <div className="mb-12 text-center">
                        <div className="w-20 h-20 bg-white/10 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-white/20 backdrop-blur-md">
                            <Shield className="text-white" size={40} />
                        </div>
                        <h1 className="text-2xl font-bold text-white uppercase tracking-widest">Infinity Saver</h1>
                        <p className="text-blue-300/60 text-xs mt-2 font-medium tracking-widest uppercase">Internal Secure Access for RH5</p>
                    </div>
                    <div className="flex gap-4 mb-16">
                        {[0, 1, 2, 3].map(i => (
                            <div key={i} className={`w-3.5 h-3.5 rounded-full border-2 border-white/30 transition-all ${pin.length > i ? 'bg-white border-white scale-125 shadow-lg shadow-white/50' : ''}`} />
                        ))}
                    </div>
                    <div className="grid grid-cols-3 gap-6">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                            <button key={n} onClick={() => handlePress(n)} className="w-16 h-16 rounded-full bg-white/5 border border-white/10 text-white text-2xl font-light hover:bg-white/20 active:scale-90 transition-all">{n}</button>
                        ))}
                        <div />
                        <button onClick={() => handlePress(0)} className="w-16 h-16 rounded-full bg-white/5 border border-white/10 text-white text-2xl font-light hover:bg-white/20 active:scale-90 transition-all">0</button>
                        <button onClick={() => setPin(pin.slice(0, -1))} className="w-16 h-16 flex items-center justify-center text-white/40"><Delete /></button>
                    </div>
                </div>
            );
        };

        // --- INPUT VIEW ---
        const InputView = ({ inputs, setInputs, onCalc, loading }) => (
            <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col">
                <div className="p-10 bg-[#002d63] text-white rounded-b-[3rem] shadow-xl">
                    <div className="flex items-center gap-3 mb-4">
                        <Calculator className="text-orange-400" />
                        <h2 className="text-xl font-black tracking-tight">RH5 | Infinity Saver Calculator</h2>
                    </div>
                    <p className="text-blue-100/60 text-sm leading-relaxed">เครื่องมือคำนวณผลประโยชน์ แบบประกันอินฟินิตี้ เซฟเวอร์</p>
                </div>
                <div className="p-8 space-y-8 flex-1">
                    <div className="grid grid-cols-2 p-1 bg-slate-100 rounded-2xl border border-slate-200">
                        <button onClick={() => setInputs({...inputs, gender: 'm'})} className={`py-3.5 rounded-xl text-sm font-bold transition-all ${inputs.gender==='m'?'bg-white text-[#002d63] shadow-md':'text-slate-400'}`}>ชาย</button>
                        <button onClick={() => setInputs({...inputs, gender: 'f'})} className={`py-3.5 rounded-xl text-sm font-bold transition-all ${inputs.gender==='f'?'bg-white text-[#f68b1f] shadow-md':'text-slate-400'}`}>หญิง</button>
                    </div>
                    <div className="space-y-2">
                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">อายุผู้เอาประกัน (ปี)</label>
                        <input type="number" value={inputs.age} onChange={e => setInputs({...inputs, age: parseInt(e.target.value)||''})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-2xl font-black text-[#002d63] focus:border-orange-400 outline-none transition-all" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={() => setInputs({...inputs, mode: 'sa'})} className={`p-4 rounded-2xl border-2 text-left transition-all ${inputs.mode==='sa'?'border-[#002d63] bg-blue-50':'border-slate-100'}`}>
                            <div className="text-xs font-bold text-slate-400 mb-1">ระบุจาก</div>
                            <div className="font-black text-[#002d63]">ทุนประกัน</div>
                        </button>
                        <button onClick={() => setInputs({...inputs, mode: 'premium'})} className={`p-4 rounded-2xl border-2 text-left transition-all ${inputs.mode==='premium'?'border-[#002d63] bg-blue-50':'border-slate-100'}`}>
                            <div className="text-xs font-bold text-slate-400 mb-1">ระบุจาก</div>
                            <div className="font-black text-[#002d63]">เบี้ยประกัน</div>
                        </button>
                    </div>
                    <div className="space-y-2">
                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">{inputs.mode==='sa'?'ทุนประกันภัย':'เบี้ยประกันต่อปี'}</label>
                        <div className="relative">
                            <input type="number" value={inputs.amount} onChange={e => setInputs({...inputs, amount: parseInt(e.target.value)||''})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-5 text-3xl font-black text-[#002d63] focus:border-orange-400 outline-none transition-all" />
                            <div className="absolute right-6 top-1/2 -translate-y-1/2 text-slate-300 font-bold">฿</div>
                        </div>
                    </div>
                    <button onClick={onCalc} disabled={loading} className="w-full bg-gradient-to-r from-[#002d63] to-[#0052b4] text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-3">
                        {loading ? <RefreshCcw className="animate-spin" /> : <>คำนวณผลประโยชน์ <ArrowRight size={20}/></>}
                    </button>
                </div>
            </div>
        );

        // --- DASHBOARD VIEW ---
        const Dashboard = ({ result, inputs, onBack, onReport }) => {
            const [showAllRows, setShowAllRows] = useState(false);
            const f = (v) => v?.toLocaleString(undefined, { maximumFractionDigits: 0 }) || '0';
            
            const cashbackYearly = result.sa * 0.088;
            const cashbackDuration = 87 - inputs.age;

            return (
                <div className="max-w-4xl mx-auto pb-32 p-4 md:p-8">
                    <div className="flex items-center justify-between mb-8">
                        <button onClick={onBack} className="p-3 bg-white rounded-2xl shadow-sm text-slate-400 hover:text-[#002d63]"><ChevronLeft /></button>
                        <h2 className="font-black text-[#002d63] uppercase tracking-tight">สรุปผลประโยชน์</h2>
                        <div className="w-12" />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <Metric label="เบี้ยประกัน/ปี" val={f(result.annPrem)} sub="ชำระ 8 ปี" color="text-[#002d63]" />
                        <Metric label="ทุนประกันภัย" val={f(result.sa)} sub="Infinity Saver 88/8" color="text-slate-600" />
                        <Metric label="IRR เฉลี่ย" val={result.irr ? result.irr.toFixed(2)+'%' : '-'} sub="ต่อปี (ตลอดสัญญา)" color="text-green-600" />
                    </div>

                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 mb-8">
                        <div className="flex items-center gap-3 mb-10 border-b border-slate-50 pb-6">
                            <div className="w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-orange-500"><PieChart /></div>
                            <div>
                                <h3 className="font-black text-[#002d63]">การวิเคราะห์กระแสเงินสด</h3>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Financial Projection Analysis</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                            <div className="space-y-6">
                                <Row label="เงินคืนรายปี (8.8% x ทุน)" val={f(result.sa * 0.088)} />
                                <Row label="เงินคืนสะสมระหว่างสัญญา" val={f(result.cumCash)} />
                                <Row label="เงินครบสัญญา (888% x ทุน)" val={f(result.maturity)} />
                                <div className="pt-4 border-t border-slate-100 flex justify-between items-end">
                                    <span className="text-xs font-bold text-slate-400 uppercase">รวมรับตลอดสัญญา</span>
                                    <span className="text-3xl font-black text-[#002d63]">{f(result.totalBenefit)} <small className="text-xs font-normal">฿</small></span>
                                </div>
                                <div className="bg-green-50 p-6 rounded-3xl border border-green-100">
                                    <div className="flex justify-between items-center">
                                        <span className="font-bold text-green-700">ผลประโยชน์สุทธิ</span>
                                        <span className="text-2xl font-black text-green-700">+{f(result.netProfit)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* MARKETING TEXT */}
                            <div className="bg-blue-50 rounded-3xl p-6 flex flex-col items-center justify-center text-center border border-blue-100">
                                <TrendingUp size={48} className="text-[#002d63] mb-4 opacity-20" />
                                <h4 className="font-black text-[#002d63] text-lg mb-2">จุดเด่นของแบบประกัน</h4>
                                <p className="text-slate-600 font-medium px-4 leading-relaxed">
                                    “สร้างกระแสเงินสดอย่างต่อเนื่อง ปีละ <span className="text-orange-500 font-bold text-xl">{f(cashbackYearly)}</span> บาท นาน <span className="text-[#002d63] font-bold text-xl">{cashbackDuration}</span> ปี”
                                </p>
                                <p className="mt-4 text-[10px] text-slate-400 font-bold uppercase tracking-widest">Cash Flow Generator</p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-sm">
                        <div className="p-6 bg-slate-50/50 border-b border-slate-100 flex justify-between items-center">
                            <div className="font-black text-[#002d63] text-sm uppercase tracking-widest">
                                ตารางแสดงผลประโยชน์และความคุ้มครองชีวิต
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <span className={`text-xs font-bold ${!showAllRows ? 'text-[#002d63]' : 'text-slate-400'}`}>ย่อ</span>
                                <div 
                                    className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"
                                    onClick={() => setShowAllRows(!showAllRows)}
                                >
                                    <input type="checkbox" name="toggle" id="toggle" checked={showAllRows} readOnly className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                                    <label htmlFor="toggle" className="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                                </div>
                                <span className={`text-xs font-bold ${showAllRows ? 'text-[#002d63]' : 'text-slate-400'}`}>ทั้งหมด</span>
                            </div>
                        </div>
                        
                        <div className="overflow-x-auto max-h-[600px] custom-scrollbar">
                            <table className="w-full text-sm">
                                <thead className="text-[10px] uppercase font-bold text-slate-400 bg-slate-50/30 sticky top-0 z-10 backdrop-blur-sm">
                                    <tr>
                                        <th className="p-5 text-left bg-slate-50">ปีที่</th>
                                        <th className="p-5 text-center bg-slate-50">อายุ</th>
                                        <th className="p-5 text-right bg-slate-50">เบี้ยประกัน</th>
                                        <th className="p-5 text-right text-[#002d63] bg-slate-50">ความคุ้มครองชีวิต</th>
                                        <th className="p-5 text-right text-green-600 bg-slate-50">เงินคืนสิ้นปี</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {result.flows
                                        .filter((_, i) => showAllRows ? true : (i < 8 || (i+1)%10 === 0 || i === result.flows.length-1))
                                        .map((r, i) => (
                                        <tr key={i} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-5 font-black text-slate-300">{r.year}</td>
                                            <td className="p-5 text-center font-bold">{r.age}</td>
                                            <td className="p-5 text-right font-bold text-red-400">{r.premium > 0 ? f(r.premium) : '-'}</td>
                                            <td className="p-5 text-right font-black text-[#002d63]">{f(r.deathBenefit)}</td>
                                            <td className="p-5 text-right font-black text-green-600">{f(r.totalYearly)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="fixed bottom-0 inset-x-0 p-6 bg-white/90 backdrop-blur-xl border-t border-slate-100 flex gap-4 max-w-4xl mx-auto z-50 shadow-[0_-20px_40px_rgba(0,0,0,0.05)]">
                        <button onClick={onBack} className="flex-1 py-5 bg-slate-100 text-slate-600 rounded-3xl font-black text-sm flex items-center justify-center gap-2 hover:bg-slate-200 transition-all"><Home size={18}/> Home </button>
                        <button onClick={onReport} className="flex-1 py-5 bg-[#002d63] text-white rounded-3xl font-black text-sm flex items-center justify-center gap-2 shadow-xl shadow-blue-200 hover:bg-blue-800 transition-all"><FileText size={18}/> พิมพ์รายงาน PDF</button>
                    </div>
                </div>
            );
        };

        // --- REPORT VIEW ---
        const ReportView = ({ result, inputs, onBack }) => {
            const f = (v) => v?.toLocaleString(undefined, { maximumFractionDigits: 0 }) || '0';
            const now = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            const handleSavePDF = () => {
                const element = document.getElementById('report-content');
                const btn = document.getElementById('save-btn');
                
                const opt = {
                    margin: 0,
                    filename: `InfinitySaver88_8_Age${inputs.age}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                if (window.html2pdf) {
                    const oldText = btn.innerHTML;
                    btn.innerHTML = 'Generating...';
                    window.html2pdf().set(opt).from(element).save().then(() => {
                        btn.innerHTML = oldText;
                    });
                } else {
                    alert("PDF Library is loading. Please try again in a moment.");
                }
            };

            return (
                <div className="min-h-screen bg-slate-800 flex flex-col items-center overflow-auto">
                    <div className="fixed top-0 inset-x-0 h-16 bg-slate-900 text-white flex items-center justify-between px-6 z-50 no-print" data-html2canvas-ignore="true">
                        <button onClick={onBack} className="text-slate-400 hover:text-white flex items-center gap-2 text-sm font-bold"><ChevronLeft size={18}/> ย้อนกลับ</button>
                        <div className="text-[10px] font-black uppercase tracking-widest opacity-40">Infinity Saver 88/8 Report Viewer</div>
                        <button id="save-btn" onClick={handleSavePDF} className="bg-[#002d63] px-6 py-2 rounded-xl text-xs font-black shadow-lg flex items-center gap-2 hover:bg-blue-800 transition-all">
                            <Download size={16}/> DOWNLOAD PDF
                        </button>
                    </div>

                    <div id="report-content" className="bg-white w-full max-w-[210mm] min-h-[297mm] my-24 p-[15mm] md:p-[20mm] text-slate-900 relative shadow-2xl">
                        
                        <div className="flex justify-between items-start border-b-4 border-[#002d63] pb-8 mb-10">
                            <div>
                                <h1 className="text-4xl font-black text-[#002d63] tracking-tight mb-2 uppercase">Infinity Saver 88/8</h1>
                                <p className="text-slate-400 text-sm font-bold">โครงการเพื่อการวางแผนทางการเงินและคุ้มครองชีวิตแบบอินฟินิตี้</p>
                            </div>
                            <div className="text-right flex flex-col items-end">
                                <div className="text-[#002d63]">
                                    <InfinityIcon size={48} strokeWidth={2.5} />
                                </div>
                                <div className="w-24 h-1 bg-orange-500 mt-2" />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-10 mb-10">
                            <div className="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                                <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">Customer Details</h4>
                                <div className="text-xl font-black text-[#002d63]">คุณ (เพศ{inputs.gender==='m'?'ชาย':'หญิง'})</div>
                                <div className="text-sm font-bold text-slate-600 mt-1">อายุผู้เอาประกัน: {inputs.age} ปี</div>
                                <div className="text-sm font-bold text-slate-600">ระยะเวลาคุ้มครอง: ถึงอายุ 88 ปี</div>
                                <div className="text-sm font-bold text-slate-600">ระยะเวลาชำระเบี้ย: 8 ปี</div>
                            </div>
                            <div className="p-6 text-right flex flex-col justify-center">
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Generated On</div>
                                <div className="text-sm font-bold text-slate-800">{now}</div>
                                <div className="mt-4 text-[10px] font-black px-4 py-1.5 bg-blue-50 text-[#002d63] rounded-full inline-block ml-auto border border-blue-100">QUOTATION DRAFT #RH5</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-6 mb-10">
                            <ReportMetric label="ทุนประกันภัย" val={f(result.sa)} />
                            <ReportMetric label="เบี้ยประกัน/ปี" val={f(result.annPrem)} highlight />
                            <ReportMetric label="เงินคืนรายปี (8.8%)" val={f(result.sa * 0.088)} />
                        </div>

                        <div className="bg-slate-50 p-8 rounded-[2rem] mb-10 border border-slate-100">
                            <h3 className="font-black text-[#002d63] text-lg mb-6 uppercase tracking-wide">สรุปผลประโยชน์รวมตลอดสัญญา</h3>
                            <div className="space-y-4">
                                <ReportRow label="รวมรับเงินคืนรายปีตลอดสัญญา" val={f(result.cumCash)} />
                                <ReportRow label="เงินครบกำหนดสัญญา (888% ของทุน)" val={f(result.maturity)} />
                                <div className="h-px bg-slate-200 my-2" />
                                <div className="flex justify-between items-end">
                                    <span className="font-black text-slate-800">ผลประโยชน์รับรวมตลอดโครงการ</span>
                                    <span className="text-3xl font-black text-[#002d63]">{f(result.totalBenefit)} <small className="text-xs font-normal">บาท</small></span>
                                </div>
                                <div className="flex justify-between items-center text-red-500 font-bold text-sm">
                                    <span>หัก เบี้ยประกันภัยรวม (8 ปี)</span>
                                    <span>- {f(result.cumPrem)} บาท</span>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm">
                                    <span className="font-black text-slate-900">กำไรสุทธิคงเหลือ (Net Gain)</span>
                                    <span className="text-2xl font-black text-green-600">+{f(result.netProfit)} บาท</span>
                                </div>
                            </div>
                        </div>

                        <div className="mb-8">
                            <h4 className="font-black text-[#002d63] text-sm mb-4 border-l-4 border-orange-500 pl-4 uppercase tracking-widest">ตารางแสดงความคุ้มครองชีวิตขั้นบันได</h4>
                            
                            <table className="w-full text-[10px] border-collapse">
                                <thead>
                                    <tr className="bg-[#002d63] text-white">
                                        <th className="p-2 text-left">สิ้นปีที่</th>
                                        <th className="p-2 text-center">อายุ</th>
                                        <th className="p-2 text-right">เบี้ยประกัน</th>
                                        <th className="p-2 text-right">ความคุ้มครอง</th>
                                        <th className="p-2 text-right">เงินคืน/ครบสัญญา</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 border-x border-slate-50">
                                    {result.flows.filter((_, i) => i < 8 || (i+1)%5 === 0 || i === result.flows.length-1).map((r, i) => (
                                        <tr key={i}>
                                            <td className="p-2 font-black text-slate-400">{r.year}</td>
                                            <td className="p-2 text-center font-bold text-slate-600">{r.age}</td>
                                            <td className="p-2 text-right font-bold text-red-500">{r.premium > 0 ? f(r.premium) : '-'}</td>
                                            <td className="p-2 text-right font-black text-[#002d63]">{f(r.deathBenefit)}</td>
                                            <td className="p-2 text-right font-black text-green-600">{f(r.totalYearly)}</td>
                                        </tr>
                                    ))}
                                    <tr className="bg-blue-50/50 font-black">
                                        <td colSpan="4" className="p-3 text-[#002d63]">ครบกำหนดสัญญา (888% ของทุนประกัน)</td>
                                        <td className="p-3 text-right text-[#002d63]">{f(result.maturity)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div className="mt-auto pt-6 border-t border-slate-100">
                            <div className="bg-yellow-50/50 p-4 rounded-2xl border border-yellow-100 mb-4">
                                <h5 className="text-[9px] font-black text-yellow-700 uppercase mb-1">คำเตือน (Disclaimer)</h5>
                                <p className="text-[9px] text-slate-500 leading-relaxed text-justify">
                                    เอกสารนี้จัดทำขึ้นเพื่อประกอบการแนะนำเบื้องต้นเท่านั้น ไม่ใช่ใบเสนอขายอย่างเป็นทางการ | ผู้ขอเอาประกันภัยควรทำความเข้าใจในรายละเอียดความคุ้มครองและเงื่อนไขก่อนตัดสินใจทำประกันภัยทุกครั้ง | ผลประโยชน์และความคุ้มครองเป็นไปตามข้อกำหนดในกรมธรรม์
                                </p>
                            </div>
                            <div className="text-center text-[10px] font-black text-slate-300 tracking-widest uppercase flex items-center justify-center gap-2">
                                <InfinityIcon size={12}/> INFINITY SAVER CACLULATOR SYSTEM
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Metric = ({ label, val, sub, color }) => (
            <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm text-center">
                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{label}</div>
                <div className={`text-2xl font-black ${color}`}>{val}</div>
                <div className="text-[10px] text-slate-300 font-bold mt-1">{sub}</div>
            </div>
        );

        const Row = ({ label, val }) => (
            <div className="flex justify-between items-center text-sm">
                <span className="text-slate-400 font-bold">{label}</span>
                <span className="font-black text-[#002d63]">{val}</span>
            </div>
        );

        const ReportMetric = ({ label, val, highlight }) => (
            <div className={`p-5 rounded-3xl border-2 text-center ${highlight ? 'border-[#002d63] bg-blue-50/20' : 'border-slate-50'}`}>
                <div className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">{label}</div>
                <div className={`text-xl font-black ${highlight ? 'text-[#002d63]' : 'text-slate-700'}`}>{val}</div>
            </div>
        );

        const ReportRow = ({ label, val }) => (
            <div className="flex justify-between items-center text-sm font-bold text-slate-600">
                <span>{label}</span>
                <span>{val} บาท</span>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

